# Database Migrations with Alembic

This project uses Alembic for database schema migrations with async SQLAlchemy support.

## Migration Workflow Summary

### Development Workflow

#### Creating Migrations
```bash
# 1. Modify your database schema (database/values.py)
# 2. Generate migration automatically
uv run alembic revision --autogenerate -m "Description of changes"

# OR create empty migration for manual changes
uv run alembic revision -m "Description of changes"
```

#### Running Migrations
```bash
# Apply all pending migrations
uv run alembic upgrade head

# Apply specific number of migrations
uv run alembic upgrade +2

# Rollback one migration
uv run alembic downgrade -1

# Rollback to specific revision
uv run alembic downgrade <revision_id>
```

#### Checking Status
```bash
# Current migration state
uv run alembic current

# Migration history
uv run alembic history

# Show pending migrations
uv run alembic heads
```

### Production Deployment

#### For New Production Environment:
```bash
# 1. Deploy code with migrations
# 2. Run all migrations to set up schema
uv run alembic upgrade head
```

#### For Existing Production Environment:
```bash
# 1. Deploy new code
# 2. Run pending migrations
uv run alembic upgrade head
```

#### Production Safety Tips:
- **Always backup database before migrations**
- **Test migrations on staging environment first**
- **Review autogenerated migrations** - they can be wrong and need manual fixes
- **Consider downtime** for large table changes
- **Verify migrations work in both directions** (upgrade/downgrade)

### Configuration

#### Key Files
- **`alembic.ini`**: Alembic configuration
- **`alembic/env.py`**: Migration environment setup (configured for async SQLAlchemy)
- **`alembic/versions/`**: Individual migration files
- **`database/values.py`**: Your SQLAlchemy table definitions

#### Database URL Configuration
Migrations use the `DATABASE_URL` environment variable (same as your app). Make sure this is set in all environments:

```bash
# Example
export DATABASE_URL="sqlite+aiosqlite:///./database.db"
```

### Common Issues

#### Autogenerated Migrations
- Always review autogenerated migrations before applying
- Alembic can generate incorrect migrations if the database state doesn't match migration history
- You may need to manually edit the migration files

#### SQLite Limitations
- SQLite doesn't support dropping columns directly
- Column drops require table recreation (see existing migration examples)

### Migration Best Practices

1. **One logical change per migration**
2. **Descriptive migration messages**
3. **Test both upgrade and downgrade**
4. **Backup before production migrations**
5. **Review all autogenerated code**

### Example Migration Structure
```python
def upgrade() -> None:
    """Apply schema changes."""
    # Your upgrade logic here
    pass

def downgrade() -> None:
    """Reverse schema changes."""
    # Your downgrade logic here
    pass
```

The migration system is fully configured and ready for production use!